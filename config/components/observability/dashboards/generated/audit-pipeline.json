{
   "description": "Concise, single-screen overview for rapid issue identification. End-to-end monitoring: K8s API → Vector → NATS → ClickHouse → Activity API. For K8s Events pipeline, see Events Pipeline dashboard.",
   "editable": true,
   "graphTooltip": 1,
   "panels": [
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
         },
         "id": 1,
         "title": "Critical Health Indicators",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Events/sec entering pipeline from K8s API servers",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "red",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 1
                     },
                     {
                        "color": "green",
                        "value": 10
                     }
                  ]
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 0,
            "y": 1
         },
         "id": 2,
         "options": {
            "colorMode": "value",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_sent_events_total{component_id=\"parse_webhook_batch\",namespace=\"activity-system\",pod=~\"vector-sidecar.*\"}[5m]))",
               "legendFormat": "Events/sec"
            }
         ],
         "title": "Ingress Rate",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Events/sec written to ClickHouse (should match ingress)",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "red",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 1
                     },
                     {
                        "color": "green",
                        "value": 10
                     }
                  ]
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 3,
            "y": 1
         },
         "id": 3,
         "options": {
            "colorMode": "value",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "activity:vector_writes:5m",
               "legendFormat": "Events/sec"
            }
         ],
         "title": "Egress Rate",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Messages pending in NATS queue (indicator of backpressure)",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "green",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 1000
                     },
                     {
                        "color": "red",
                        "value": 10000
                     }
                  ]
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 6,
            "y": 1
         },
         "id": 4,
         "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "activity:nats_consumer_lag",
               "legendFormat": "Pending"
            }
         ],
         "title": "Queue Backlog",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Combined errors across all pipeline components",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "green",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 0.10000000000000001
                     },
                     {
                        "color": "red",
                        "value": 1
                     }
                  ]
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 9,
            "y": 1
         },
         "id": 5,
         "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_errors_total{namespace=\"activity-system\"}[5m])) + sum(rate(activity_clickhouse_query_errors_total[5m]))",
               "legendFormat": "Errors/sec"
            }
         ],
         "title": "Error Rate",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Average time to write events to ClickHouse",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "green",
                        "value": null
                     },
                     {
                        "color": "yellow",
                        "value": 0.10000000000000001
                     },
                     {
                        "color": "orange",
                        "value": 0.5
                     },
                     {
                        "color": "red",
                        "value": 1
                     }
                  ]
               },
               "unit": "s"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 12,
            "y": 1
         },
         "id": 6,
         "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(chi_clickhouse_event_InsertQueryTimeMicroseconds{chi=\"activity-clickhouse\"}[5m]) / rate(chi_clickhouse_event_InsertQuery{chi=\"activity-clickhouse\"}[5m]) / 1000000)",
               "legendFormat": "Insert Latency"
            }
         ],
         "title": "ClickHouse Insert Latency",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "All pipeline components UP",
         "fieldConfig": {
            "defaults": {
               "mappings": [
                  {
                     "options": {
                        "0": {
                           "color": "red",
                           "text": "DOWN"
                        }
                     },
                     "type": "value"
                  },
                  {
                     "options": {
                        "1": {
                           "color": "green",
                           "text": "ALL UP"
                        }
                     },
                     "type": "value"
                  }
               ],
               "thresholds": {
                  "steps": [
                     {
                        "color": "red",
                        "value": null
                     },
                     {
                        "color": "green",
                        "value": 1
                     }
                  ]
               }
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 15,
            "y": 1
         },
         "id": 7,
         "options": {
            "colorMode": "background",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            },
            "textMode": "value_and_name"
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "min(up{job=~\"vector|nats-system/nats|clickhouse-activity-clickhouse|activity-apiserver\",namespace=~\"activity-system|nats-system\"})",
               "legendFormat": "Status"
            }
         ],
         "title": "Component Health",
         "type": "stat"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "API requests rejected due to audit backend failure - CRITICAL if >0",
         "fieldConfig": {
            "defaults": {
               "thresholds": {
                  "steps": [
                     {
                        "color": "green",
                        "value": null
                     },
                     {
                        "color": "red",
                        "value": 1
                     }
                  ]
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 4,
            "w": 3,
            "x": 18,
            "y": 1
         },
         "id": 8,
         "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
               "calcs": [
                  "lastNotNull"
               ]
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(apiserver_audit_requests_rejected_total{job=~\".*apiserver.*\"})",
               "legendFormat": "Rejected"
            }
         ],
         "title": "Requests Rejected",
         "type": "stat"
      },
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
         },
         "id": 9,
         "title": "API Server Audit Generation",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "API server event generation vs Vector ingestion - gap indicates lost events",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 0,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 0,
            "y": 6
         },
         "id": 10,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(apiserver_audit_event_total{job=~\".*apiserver.*\"}[5m]))",
               "legendFormat": "API Server Generated"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_sent_events_total{component_id=\"parse_webhook_batch\",namespace=\"activity-system\",pod=~\"vector-sidecar.*\"}[5m]))",
               "legendFormat": "Vector Ingested"
            }
         ],
         "title": "Audit Event Generation vs Ingestion",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Audit events that failed to be written - should be ZERO in healthy state",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 8,
            "y": 6
         },
         "id": 11,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(apiserver_audit_error_total{job=~\".*apiserver.*\"}[5m])) by (plugin)",
               "legendFormat": "{{plugin}} errors"
            }
         ],
         "title": "Audit Backend Errors",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Distribution of audit events by policy level (Metadata/Request/RequestResponse)",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never",
                  "stacking": {
                     "mode": "normal"
                  }
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 16,
            "y": 6
         },
         "id": 12,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(apiserver_audit_level_total{job=~\".*apiserver.*\"}[5m])) by (level)",
               "legendFormat": "{{level}}"
            }
         ],
         "title": "Audit Policy Levels",
         "type": "timeseries"
      },
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 13
         },
         "id": 13,
         "title": "Pipeline Flow",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Events per second at each pipeline stage - should be roughly equal in steady state",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 14
         },
         "id": 14,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_sent_events_total{component_id=\"parse_webhook_batch\",namespace=\"activity-system\",pod=~\"vector-sidecar.*\"}[5m]))",
               "legendFormat": "1. Webhook Ingress"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_sent_events_total{component_id=\"nats_jetstream\",pod=~\"vector-sidecar.*\"}[5m]))",
               "legendFormat": "2. Published to NATS"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "activity:vector_throughput:5m",
               "legendFormat": "3. Consumed from NATS"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "activity:vector_writes:5m",
               "legendFormat": "4. Sent to ClickHouse"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(rate(chi_clickhouse_table_parts_rows{chi=\"activity-clickhouse\", database=\"audit\", table=\"events\", active=\"1\"}[5m]))",
               "legendFormat": "5. ClickHouse Writes"
            }
         ],
         "title": "Event Flow Through Pipeline Stages",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Pipeline input vs output - gap indicates bottleneck or filtering",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 0,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 14
         },
         "id": 15,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(rate(vector_component_sent_events_total{component_id=\"parse_webhook_batch\",namespace=\"activity-system\",pod=~\"vector-sidecar.*\"}[5m]))",
               "legendFormat": "Ingress (API Servers)"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(rate(chi_clickhouse_table_parts_rows{chi=\"activity-clickhouse\", database=\"audit\", table=\"events\", active=\"1\"}[5m]))",
               "legendFormat": "Egress (ClickHouse)"
            }
         ],
         "title": "Ingress vs Egress Comparison",
         "type": "timeseries"
      },
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 22
         },
         "id": 16,
         "title": "Performance Deep Dive",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Time from K8s API event generation to Vector aggregator processing (stageTimestamp → now)",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "s"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 23
         },
         "id": 17,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "histogram_quantile(0.99, sum(rate(activity_pipeline_end_to_end_latency_seconds_bucket{stage=\"nats_to_aggregator\"}[5m])) by (le))",
               "legendFormat": "p99"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "histogram_quantile(0.95, sum(rate(activity_pipeline_end_to_end_latency_seconds_bucket{stage=\"nats_to_aggregator\"}[5m])) by (le))",
               "legendFormat": "p95"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "histogram_quantile(0.50, sum(rate(activity_pipeline_end_to_end_latency_seconds_bucket{stage=\"nats_to_aggregator\"}[5m])) by (le))",
               "legendFormat": "p50"
            }
         ],
         "title": "End-to-End Latency (p50/p95/p99)",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Pending and unacknowledged messages - indicators of backpressure",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 20,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 23
         },
         "id": 18,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "activity:nats_consumer_lag",
               "legendFormat": "Pending Messages"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "nats_consumer_num_ack_pending{consumer_name=\"clickhouse-ingest\"}",
               "legendFormat": "Unacknowledged"
            }
         ],
         "title": "NATS Queue Backlog",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Buffer depth indicates ClickHouse backpressure - high values mean slow writes",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 30
         },
         "id": 19,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(vector_buffer_events{component_id=\"clickhouse\",namespace=\"activity-system\"})",
               "legendFormat": "Buffered Events"
            }
         ],
         "title": "Vector Aggregator Buffer Depth",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Insert rate and latency - write path health",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 30
         },
         "id": 20,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(rate(chi_clickhouse_table_parts_rows{chi=\"activity-clickhouse\", database=\"audit\", table=\"events\", active=\"1\"}[5m]))",
               "legendFormat": "Rows Inserted/sec"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(chi_clickhouse_metric_InsertQuery{chi=\"activity-clickhouse\"})",
               "legendFormat": "Active Insert Queries"
            }
         ],
         "title": "ClickHouse Insert Performance",
         "type": "timeseries"
      },
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 37
         },
         "id": 21,
         "title": "Resource Saturation",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Concurrent operations - high values indicate database saturation",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "lineWidth": 1,
                  "showPoints": "never",
                  "stacking": {
                     "mode": "normal"
                  }
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 0,
            "y": 38
         },
         "id": 22,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(chi_clickhouse_metric_InsertQuery{chi=\"activity-clickhouse\"})",
               "legendFormat": "Inserts"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(chi_clickhouse_metric_Query{chi=\"activity-clickhouse\"})",
               "legendFormat": "Queries"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "sum(chi_clickhouse_metric_Merge{chi=\"activity-clickhouse\"})",
               "legendFormat": "Merges"
            }
         ],
         "title": "ClickHouse Active Operations",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Merge rate should be 10-100x insert rate for healthy consolidation",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 8,
            "y": 38
         },
         "id": 23,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(rate(chi_clickhouse_table_parts_rows{chi=\"activity-clickhouse\", database=\"audit\", table=\"events\", active=\"1\"}[5m]))",
               "legendFormat": "Insert Rate"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(rate(chi_clickhouse_event_MergedRows{chi=\"activity-clickhouse\"}[5m]))",
               "legendFormat": "Merge Rate"
            }
         ],
         "title": "Merge Activity vs Insert Rate",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "$datasource"
         },
         "description": "Number of data parts - high count (>100) slows queries, needs more merging",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 10,
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "short"
            }
         },
         "gridPos": {
            "h": 7,
            "w": 8,
            "x": 16,
            "y": 38
         },
         "id": 24,
         "options": {
            "legend": {
               "calcs": [
                  "mean",
                  "lastNotNull",
                  "max"
               ],
               "displayMode": "table",
               "placement": "bottom",
               "showLegend": true
            }
         },
         "pluginVersion": "v11.4.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "expr": "avg(chi_clickhouse_table_parts{chi=\"activity-clickhouse\",database=\"audit\",table=\"events\"})",
               "legendFormat": "Total Parts"
            }
         ],
         "title": "Part Count (Query Performance Indicator)",
         "type": "timeseries"
      },
      {
         "collapsed": true,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 45
         },
         "id": 25,
         "panels": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "description": "Breakdown of errors across all pipeline components",
               "fieldConfig": {
                  "defaults": {
                     "custom": {
                        "fillOpacity": 30,
                        "lineWidth": 1,
                        "showPoints": "never",
                        "stacking": {
                           "mode": "normal"
                        }
                     },
                     "unit": "ops"
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 0,
                  "y": 46
               },
               "id": 26,
               "options": {
                  "legend": {
                     "calcs": [
                        "mean",
                        "lastNotNull",
                        "max"
                     ],
                     "displayMode": "table",
                     "placement": "right",
                     "showLegend": true
                  }
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(vector_component_errors_total{namespace=\"activity-system\",pod=~\"vector-sidecar.*\"}[5m])) by (component_id)",
                     "legendFormat": "Sidecar: {{component_id}}"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(vector_component_errors_total{namespace=\"activity-system\",pod=~\"vector-aggregator.*\"}[5m])) by (component_id)",
                     "legendFormat": "Aggregator: {{component_id}}"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "activity:clickhouse_error_rate:5m",
                     "legendFormat": "Activity: {{error_type}}"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(activity_cel_filter_errors_total[5m])) by (error_type)",
                     "legendFormat": "CEL: {{error_type}}"
                  }
               ],
               "title": "Errors by Component",
               "type": "timeseries"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "description": "Vector aggregator error breakdown - most common failure point",
               "fieldConfig": {
                  "defaults": {
                     "custom": {
                        "fillOpacity": 10,
                        "lineWidth": 2,
                        "showPoints": "never"
                     },
                     "unit": "ops"
                  }
               },
               "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 12,
                  "y": 46
               },
               "id": 27,
               "options": {
                  "legend": {
                     "calcs": [
                        "mean",
                        "lastNotNull",
                        "max"
                     ],
                     "displayMode": "table",
                     "placement": "bottom",
                     "showLegend": true
                  }
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(vector_http_client_errors_total{component_id=\"clickhouse\",namespace=\"activity-system\"}[5m]))",
                     "legendFormat": "HTTP Client Errors"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(vector_component_errors_total{component_id=\"clickhouse\",namespace=\"activity-system\"}[5m]))",
                     "legendFormat": "Component Errors"
                  }
               ],
               "title": "Vector Aggregator Errors Detail",
               "type": "timeseries"
            }
         ],
         "title": "Error Breakdown",
         "type": "row"
      },
      {
         "collapsed": true,
         "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 46
         },
         "id": 28,
         "panels": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "description": "User-facing query performance (p50/p95/p99)",
               "fieldConfig": {
                  "defaults": {
                     "custom": {
                        "fillOpacity": 10,
                        "lineWidth": 2,
                        "showPoints": "never"
                     },
                     "unit": "s"
                  }
               },
               "gridPos": {
                  "h": 7,
                  "w": 8,
                  "x": 0,
                  "y": 47
               },
               "id": 29,
               "options": {
                  "legend": {
                     "calcs": [
                        "mean",
                        "lastNotNull",
                        "max"
                     ],
                     "displayMode": "table",
                     "placement": "bottom",
                     "showLegend": true
                  }
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "activity:query_duration:p50",
                     "legendFormat": "p50"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "activity:query_duration:p95",
                     "legendFormat": "p95"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "activity:query_duration:p99",
                     "legendFormat": "p99"
                  }
               ],
               "title": "Activity API Query Latency",
               "type": "timeseries"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "description": "Query volume and error rates",
               "fieldConfig": {
                  "defaults": {
                     "custom": {
                        "fillOpacity": 10,
                        "lineWidth": 2,
                        "showPoints": "never"
                     },
                     "unit": "ops"
                  }
               },
               "gridPos": {
                  "h": 7,
                  "w": 8,
                  "x": 8,
                  "y": 47
               },
               "id": 30,
               "options": {
                  "legend": {
                     "calcs": [
                        "mean",
                        "lastNotNull"
                     ],
                     "displayMode": "table",
                     "placement": "bottom",
                     "showLegend": true
                  }
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(activity_clickhouse_query_total{status=\"success\"}[5m]))",
                     "legendFormat": "Successful Queries"
                  },
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "sum(rate(activity_clickhouse_query_errors_total[5m]))",
                     "legendFormat": "Failed Queries"
                  }
               ],
               "title": "Query Rate & Errors",
               "type": "timeseries"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "$datasource"
               },
               "description": "Query distribution by scope type",
               "fieldConfig": {
                  "defaults": {
                     "custom": {
                        "fillOpacity": 10,
                        "lineWidth": 2,
                        "showPoints": "never",
                        "stacking": {
                           "mode": "normal"
                        }
                     },
                     "unit": "ops"
                  }
               },
               "gridPos": {
                  "h": 7,
                  "w": 8,
                  "x": 16,
                  "y": 47
               },
               "id": 31,
               "options": {
                  "legend": {
                     "calcs": [
                        "mean",
                        "lastNotNull"
                     ],
                     "displayMode": "table",
                     "placement": "bottom",
                     "showLegend": true
                  }
               },
               "pluginVersion": "v11.4.0",
               "targets": [
                  {
                     "datasource": {
                        "type": "prometheus",
                        "uid": "$datasource"
                     },
                     "expr": "rate(activity_auditlog_queries_by_scope_total[5m])",
                     "legendFormat": "{{scope_type}}"
                  }
               ],
               "title": "Query Patterns",
               "type": "timeseries"
            }
         ],
         "title": "Query Performance",
         "type": "row"
      }
   ],
   "refresh": "30s",
   "schemaVersion": 39,
   "tags": [
      "audit",
      "pipeline",
      "activity",
      "observability"
   ],
   "templating": {
      "list": [
         {
            "label": "Prometheus Datasource",
            "name": "datasource",
            "query": "prometheus",
            "regex": "Service Metrics",
            "type": "datasource"
         }
      ]
   },
   "time": {
      "from": "now-24h",
      "to": "now"
   },
   "timezone": "utc",
   "title": "Audit Log Pipeline",
   "uid": "audit-pipeline"
}

apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# ClickHouse Migrations Component
#
# This component deploys a Job that applies database migrations from configmap.yaml
#
# Architecture:
# 1. migrations/ directory is the SOURCE OF TRUTH for all migrations
# 2. configmap.yaml is AUTO-GENERATED from migrations/ via script
# 3. Job mounts ConfigMap and runs migrate.sh idempotently
# 4. Job auto-deletes after 5 minutes (ttlSecondsAfterFinished)
#
# Adding new migrations:
# 1. Create migration: migrations/002_your_migration.sql
# 2. Generate ConfigMap: task migrations:generate
# 3. Add migration to job.yaml volumes section
# 4. Deploy: task dev:deploy
#
# Example usage in overlay kustomization.yaml:
#   components:
#   - ../../components/clickhouse-migrations

resources:
- configmap.yaml
- job.yaml

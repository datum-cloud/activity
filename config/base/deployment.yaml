apiVersion: apps/v1
kind: Deployment
metadata:
  name: activity-apiserver
  namespace: activity-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: activity-apiserver
  template:
    metadata:
      labels:
        app: activity-apiserver
    spec:
      serviceAccountName: activity-apiserver
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: apiserver
        image: ghcr.io/datum-cloud/activity:latest
        imagePullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65532
          capabilities:
            drop:
            - ALL
        ports:
        - containerPort: 8443
          name: https
          protocol: TCP
        command:
        - /activity
        - serve
        args:
        - --secure-port=$(SECURE_PORT)
        - --tls-cert-file=$(TLS_CERT_FILE)
        - --tls-private-key-file=$(TLS_PRIVATE_KEY_FILE)
        - --clickhouse-address=$(CLICKHOUSE_ADDRESS)
        - --clickhouse-database=$(CLICKHOUSE_DATABASE)
        - --clickhouse-username=$(CLICKHOUSE_USERNAME)
        - --clickhouse-password=$(CLICKHOUSE_PASSWORD)
        - --clickhouse-tls-enabled=$(CLICKHOUSE_TLS_ENABLED)
        - --clickhouse-tls-cert-file=$(CLICKHOUSE_TLS_CERT_FILE)
        - --clickhouse-tls-key-file=$(CLICKHOUSE_TLS_KEY_FILE)
        - --clickhouse-tls-ca-file=$(CLICKHOUSE_TLS_CA_FILE)
        - --kubeconfig=$(KUBECONFIG)
        - --authentication-kubeconfig=$(AUTHENTICATION_KUBECONFIG)
        - --authentication-skip-lookup=$(AUTHENTICATION_SKIP_LOOKUP)
        - --authentication-tolerate-lookup-failure=$(AUTHENTICATION_TOLERATE_LOOKUP_FAILURE)
        - --authorization-kubeconfig=$(AUTHORIZATION_KUBECONFIG)
        - --authorization-always-allow-paths=$(AUTHORIZATION_ALWAYS_ALLOW_PATHS)
        - --requestheader-client-ca-file=$(REQUESTHEADER_CLIENT_CA_FILE)
        - --requestheader-username-headers=$(REQUESTHEADER_USERNAME_HEADERS)
        - --requestheader-group-headers=$(REQUESTHEADER_GROUP_HEADERS)
        - --requestheader-uid-headers=$(REQUESTHEADER_UID_HEADERS)
        - --requestheader-extra-headers-prefix=$(REQUESTHEADER_EXTRA_HEADERS_PREFIX)
        - --logging-format=$(LOGGING_FORMAT)
        - --tracing-config-file=$(TRACING_CONFIG_FILE)
        - --etcd-servers=$(ETCD_SERVERS)
        - --activities-nats-url=$(ACTIVITIES_NATS_URL)
        - --activities-nats-stream=$(ACTIVITIES_NATS_STREAM)
        - --activities-nats-subject-prefix=$(ACTIVITIES_NATS_SUBJECT_PREFIX)
        - --activities-nats-tls-enabled=$(ACTIVITIES_NATS_TLS_ENABLED)
        - --activities-nats-tls-cert-file=$(ACTIVITIES_NATS_TLS_CERT_FILE)
        - --activities-nats-tls-key-file=$(ACTIVITIES_NATS_TLS_KEY_FILE)
        - --activities-nats-tls-ca-file=$(ACTIVITIES_NATS_TLS_CA_FILE)
        - --events-nats-url=$(EVENTS_NATS_URL)
        - --events-nats-stream=$(EVENTS_NATS_STREAM)
        - --events-nats-subject-prefix=$(EVENTS_NATS_SUBJECT_PREFIX)
        - --events-nats-tls-enabled=$(EVENTS_NATS_TLS_ENABLED)
        - --events-nats-tls-cert-file=$(EVENTS_NATS_TLS_CERT_FILE)
        - --events-nats-tls-key-file=$(EVENTS_NATS_TLS_KEY_FILE)
        - --events-nats-tls-ca-file=$(EVENTS_NATS_TLS_CA_FILE)
        - -v=$(LOG_LEVEL)
        env:
        - name: SECURE_PORT
          value: "8443"
        - name: TLS_CERT_FILE
          value: "/var/run/activity-apiserver/tls/tls.crt"
        - name: TLS_PRIVATE_KEY_FILE
          value: "/var/run/activity-apiserver/tls/tls.key"
        - name: KUBECONFIG
          value: ""
        - name: AUTHENTICATION_KUBECONFIG
          value: ""
        - name: AUTHENTICATION_SKIP_LOOKUP
          value: "false"
        - name: AUTHENTICATION_TOLERATE_LOOKUP_FAILURE
          value: "false"
        - name: AUTHORIZATION_KUBECONFIG
          value: ""
        - name: AUTHORIZATION_ALWAYS_ALLOW_PATHS
          value: "/healthz,/readyz,/livez"
        - name: REQUESTHEADER_CLIENT_CA_FILE
          value: ""
        - name: REQUESTHEADER_USERNAME_HEADERS
          value: "X-Remote-User"
        - name: REQUESTHEADER_GROUP_HEADERS
          value: "X-Remote-Group"
        - name: REQUESTHEADER_UID_HEADERS
          value: "X-Remote-Uid"
        - name: REQUESTHEADER_EXTRA_HEADERS_PREFIX
          value: "X-Remote-Extra-"
        - name: LOGGING_FORMAT
          value: "json"
        - name: LOG_LEVEL
          value: "4"
        - name: TRACING_CONFIG_FILE
          value: ""
        - name: CLICKHOUSE_ADDRESS
          value: "clickhouse.activity-system.svc.cluster.local:9000"
        - name: CLICKHOUSE_DATABASE
          value: "audit"
        - name: CLICKHOUSE_USERNAME
          value: "default"
        - name: CLICKHOUSE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: clickhouse-credentials
              key: password
              optional: true
        - name: CLICKHOUSE_TLS_ENABLED
          value: "false"
        - name: CLICKHOUSE_TLS_CERT_FILE
          value: ""
        - name: CLICKHOUSE_TLS_KEY_FILE
          value: ""
        - name: CLICKHOUSE_TLS_CA_FILE
          value: ""
        - name: ETCD_SERVERS
          value: "http://etcd.activity-system.svc.cluster.local:2379"
        # NATS configuration for Activities Watch API (empty = Watch API disabled)
        - name: ACTIVITIES_NATS_URL
          value: ""
        - name: ACTIVITIES_NATS_STREAM
          value: "ACTIVITIES"
        - name: ACTIVITIES_NATS_SUBJECT_PREFIX
          value: "activities"
        - name: ACTIVITIES_NATS_TLS_ENABLED
          value: "false"
        - name: ACTIVITIES_NATS_TLS_CERT_FILE
          value: ""
        - name: ACTIVITIES_NATS_TLS_KEY_FILE
          value: ""
        - name: ACTIVITIES_NATS_TLS_CA_FILE
          value: ""
        # NATS configuration for Events Watch API (empty = Watch API disabled)
        - name: EVENTS_NATS_URL
          value: ""
        - name: EVENTS_NATS_STREAM
          value: "EVENTS"
        - name: EVENTS_NATS_SUBJECT_PREFIX
          value: "events"
        - name: EVENTS_NATS_TLS_ENABLED
          value: "false"
        - name: EVENTS_NATS_TLS_CERT_FILE
          value: ""
        - name: EVENTS_NATS_TLS_KEY_FILE
          value: ""
        - name: EVENTS_NATS_TLS_CA_FILE
          value: ""
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: https
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 10
        volumeMounts:
        - name: tls-certs
          mountPath: /var/run/activity-apiserver/tls
          readOnly: true
        - name: control-plane-ca
          mountPath: /etc/kubernetes/pki/requestheader
          readOnly: true
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tls-certs
        csi:
          driver: csi.cert-manager.io
          readOnly: true
          volumeAttributes:
            csi.cert-manager.io/issuer-name: selfsigned-cluster-issuer
            csi.cert-manager.io/issuer-kind: ClusterIssuer
            csi.cert-manager.io/common-name: activity-apiserver.activity-system.svc
            csi.cert-manager.io/dns-names: "activity-apiserver,activity-apiserver.activity-system,activity-apiserver.activity-system.svc,activity-apiserver.activity-system.svc.cluster.local"
            csi.cert-manager.io/duration: "8760h"
            csi.cert-manager.io/renew-before: "720h"
            csi.cert-manager.io/fs-group: "65532"
      - name: control-plane-ca
        configMap:
          name: control-plane-ca
          optional: true
      - name: tmp
        emptyDir: {}

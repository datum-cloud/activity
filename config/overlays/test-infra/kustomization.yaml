apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: activity-system

# Base resources (API server, service, APIService, etc.)
resources:
  - ../../base

components:
  - ../../components/namespace
  - ../../components/api-registration
  - ../../components/cert-manager-ca
  - ../../components/rustfs-bucket
  - ../../components/clickhouse-keeper      # Keeper coordination for HA
  - ../../components/clickhouse-database     # HA ClickHouse with 3 replicas
  - ../../components/clickhouse-migrations
  - ../../components/grafana-clickhouse
  - ../../components/vector-sidecar
  - ../../components/vector-aggregator
  - ../../components/tracing

# Note: NATS stream configuration (nats-streams) is in a different namespace (nats-system)
# and must be applied separately. See dev:deploy task in Taskfile.yaml
# Note: Vector sidecar is deployed to kube-system namespace
# Note: RustFS bucket initialization job will create the S3 bucket on first deployment

# Image overrides for test-infra environment
images:
  - name: ghcr.io/datum-cloud/activity
    newName: ghcr.io/datum-cloud/activity
    newTag: dev

# Patches specific to test-infra environment
patches:
  - path: patches/deployment-patch.yaml
  - path: patches/apiservice-patch.yaml
  - path: patches/vector-sidecar-patch.yaml
  - path: patches/clickhouse-affinity-patch.yaml        # Relaxed anti-affinity for single-node test cluster
  - path: patches/clickhouse-storage-patch.yaml         # RustFS storage configuration

labels:
  - includeSelectors: true
    includeTemplates: true
    pairs:
      environment: test-infra

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: activity-system

# Base resources (API server, service, APIService, etc.)
resources:
  - ../../base
  - anonymous-rbac.yaml     # Dev-only: anonymous access for Gateway
  - ../../../examples/basic-kubernetes  # Example ActivityPolicies for testing

components:
  - ../../components/namespace
  - ../../components/api-registration
  - ../../components/cert-manager-ca
  - ../../components/etcd                          # Single-node etcd for ActivityPolicy storage
  - ../../components/clickhouse-keeper-standalone  # Single-node Keeper for coordination
  - ../../components/clickhouse-standalone         # Single-replica ClickHouse
  - ../../components/clickhouse-migrations
  - ../../components/nats-streams                  # NATS JetStream streams and consumers
  - ../../components/grafana-clickhouse
  - ../../components/vector-sidecar
  - ../../components/vector-aggregator
  - ../../components/k8s-event-exporter            # Kubernetes events â†’ NATS
  - ../../components/tracing
  - ../../components/observability            # ServiceMonitors, alerts, dashboards
  - ../../components/ui                       # Activity UI web application with Envoy Gateway routing

# Note: The following HA components are excluded for dev environments:
# - clickhouse-keeper       # Replaced by clickhouse-keeper-standalone (1 replica)
# - clickhouse-database     # Replaced by clickhouse-standalone (1 replica)
# - rustfs-bucket           # No S3 cold storage in dev (uses local disk for both hot/cold)

# Image overrides for dev environment
images:
  - name: ghcr.io/datum-cloud/activity
    newName: ghcr.io/datum-cloud/activity
    newTag: dev
  - name: ghcr.io/datum-cloud/activity-ui
    newName: ghcr.io/datum-cloud/activity-ui
    newTag: dev

# Patches specific to dev environment
patches:
  - path: patches/deployment-patch.yaml
  - path: patches/activity-processor-patch.yaml
  - path: patches/controller-manager-patch.yaml
  - path: patches/reindex-image-patch.yaml
  - path: patches/apiservice-patch.yaml
  - path: patches/migration-job-patch.yaml
  - path: patches/vector-sidecar-patch.yaml
  - path: patches/vector-aggregator-patch.yaml
  # UI patch: Use in-cluster ServiceAccount auth instead of mTLS client certs
  - target:
      kind: Deployment
      name: activity-ui
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Never
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: NODE_ENV
            value: "production"
      - op: replace
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: tmp
            mountPath: /tmp
      - op: replace
        path: /spec/template/spec/volumes
        value:
          - name: tmp
            emptyDir: {}

labels:
  # Note: includeSelectors is false because operators (ClickHouse, etcd) create pods
  # without kustomize labels, causing service selector mismatches
  - includeSelectors: false
    includeTemplates: true
    pairs:
      environment: dev

version: '3'

vars:
  ROOT_DIR: '{{.ROOT_DIR | default .USER_WORKING_DIR}}'
  K6_SRC_DIR: '{{.ROOT_DIR}}/test/load/src'
  K6_DEST_DIR: '{{.ROOT_DIR}}/config/components/k6-performance-tests/generated'
  K6_NAMESPACE: 'activity-system'

tasks:
  default:
    desc: List all available load test tasks
    cmds:
      - task --list
    silent: true

  # Generate k6 ConfigMaps from source scripts
  generate:
    desc: Sync k6 test scripts from src to k6-performance-tests component
    cmds:
      - |
        set -e
        echo "üìù Syncing k6 test scripts..."
        echo "  Source:      {{.K6_SRC_DIR}}"
        echo "  Destination: {{.K6_DEST_DIR}}"
        echo ""

        # Ensure source directory exists
        if [ ! -d "{{.K6_SRC_DIR}}" ]; then
          echo "‚ùå Error: Source directory {{.K6_SRC_DIR}} does not exist"
          exit 1
        fi

        # Ensure destination directory exists
        if [ ! -d "{{.K6_DEST_DIR}}" ]; then
          echo "‚ùå Error: Destination directory {{.K6_DEST_DIR}} does not exist"
          exit 1
        fi

        # Copy all JavaScript files with generated header
        for script in {{.K6_SRC_DIR}}/*.js; do
          if [ -f "$script" ]; then
            filename=$(basename "$script")
            echo "  ‚úì Copying ${filename}..."

            # Create file with generated header and append source
            {
              echo "// Code generated by task load:generate. DO NOT EDIT."
              echo "// Source: test/load/src/"
              echo ""
              cat "$script"
            } > "{{.K6_DEST_DIR}}/${filename}"
          fi
        done

        echo ""
        echo "‚úÖ k6 test scripts synced successfully!"
        echo ""
        echo "üìã Next steps:"
        echo "  1. Review changes:  git diff {{.K6_DEST_DIR}}"
        echo "  2. Deploy to cluster: task load:deploy"
    silent: true

  # Validate k6 test scripts locally
  validate:
    desc: Validate k6 test scripts using local k6 installation
    cmds:
      - |
        set -e
        echo "üîç Validating k6 test scripts..."
        echo ""

        # Check if k6 is installed
        if ! command -v k6 &> /dev/null; then
          echo "‚ùå k6 is not installed. Please install k6 first:"
          echo ""
          echo "  macOS:   brew install k6"
          echo "  Linux:   See https://k6.io/docs/get-started/installation/"
          echo ""
          exit 1
        fi

        echo "k6 version: $(k6 version)"
        echo ""

        # Validate each script
        for script in {{.K6_SRC_DIR}}/*.js; do
          if [ -f "$script" ]; then
            filename=$(basename "$script")
            echo "Validating ${filename}..."

            # Run k6 with --no-usage-report and just do a syntax check
            # Using --duration 0s to not actually run the test
            if k6 inspect "$script" > /dev/null 2>&1; then
              echo "  ‚úì ${filename} is valid"
            else
              echo "  ‚ùå ${filename} has errors"
              k6 inspect "$script"
              exit 1
            fi
          fi
        done

        echo ""
        echo "‚úÖ All k6 test scripts are valid!"
    silent: true
